<!-- Ana Konteyner -->
<div class="chat-messages-container">
  <!-- Mesajlar Alanı -->
  <div class="messages-wrapper">
    <!-- Mesaj Listesi -->
    <div *ngIf="currentSessionId" 
         #messagesList 
         class="messages-scroll-area">
      
      <div class="messages-content">
        <!-- Mesaj Kartları -->
        <ng-container *ngFor="let message of messages">
          <div class="message-wrapper"
               [ngClass]="{
                 'user-message-wrapper': message.sender === 'user',
                 'ai-message-wrapper': message.sender === 'ai'
               }">
            
            <!-- Avatar -->
            <div class="message-avatar">
              <div class="avatar"
                   [style.background-color]="getUserAvatarColor(message.sender)"
                   (mouseenter)="onAvatarHover($event, true)"
                   (mouseleave)="onAvatarHover($event, false)">
                <i [class]="getUserAvatarIcon(message.sender)"></i>
              </div>
            </div>

            <!-- Mesaj Kartı -->
            <div class="message-card">
              <!-- Mesaj İçeriği -->
              <div class="message-content">
                <!-- Kod Blokları veya Düz Metin -->
                <ng-container *ngIf="hasCodeBlocks(message.content); else plainText">
                  <ng-container *ngFor="let part of parseMessageContent(message.content)">
                    <!-- Düz Metin -->
                    <div *ngIf="part.type === 'text'" 
                         class="text-content"
                         [style.color]="message.sender === 'user' ? 'white' : 'var(--text-primary)'">
                      {{ part.content }}
                    </div>
                    
                    <!-- Kod Bloğu -->
                    <app-code-block *ngIf="part.type === 'code'"
                                  [code]="part.content"
                                  [language]="part.language || 'text'">
                    </app-code-block>
                  </ng-container>
                </ng-container>

                <!-- Düz Metin Şablonu -->
                <ng-template #plainText>
                  <!-- Resimler -->
                  <div *ngIf="message.imageUrl && message.imageUrl.length > 0"
                       class="message-images">
                    <ng-container *ngFor="let url of message.imageUrl; trackBy: trackByImageUrl">
                      <div class="image-container">
                        <img [src]="getImageUrl(url)"
                             [attr.data-message-id]="message.id"
                             (error)="onImageError($event)"
                             class="message-img"
                             alt="Mesaj resmi">
                      </div>
                    </ng-container>
                  </div>

                  <!-- Metin İçeriği -->
                  <div *ngIf="message.content && !isImageUrl(message.content)"
                       class="text-content"
                       [style.color]="message.sender === 'user' ? 'white' : 'var(--text-primary)'">
                    {{ message.content }}
                  </div>
                </ng-template>
              </div>

              <!-- Zaman Damgası -->
              <div class="message-timestamp">
                <small>{{ message.timestamp | date:'dd MMM yyyy, HH:mm' }}</small>
              </div>
            </div>
          </div>
        </ng-container>

        <!-- AI Yazıyor Göstergesi -->
        <div *ngIf="isLoading"
             class="message-wrapper ai-message-wrapper">
          <div class="message-avatar">
            <div class="avatar typing-avatar">
              <i class="pi pi-android"></i>
            </div>
          </div>

          <div class="message-card typing-card">
            <div class="typing-indicator">
              <i class="pi pi-android"></i>
              <span>AI düşünüyor</span>
              <div class="typing-dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Aşağı Kaydırma Butonu -->
    <button *ngIf="showScrollToBottomButton"
            class="scroll-to-bottom-btn"
            (click)="scrollToBottomSmooth()"
            (mouseenter)="onButtonHover($event, true)"
            (mouseleave)="onButtonHover($event, false)"
            title="Aşağı git">
      <i class="pi pi-angle-down"></i>
    </button>
  </div>

  <!-- Mesaj Giriş Alanı - Sabit Alt Kısım -->
  <div class="message-input-container">
    <!-- Dosya Önizleme Alanı -->
    <div *ngIf="selectedFiles.length > 0"
         class="file-preview-area">
      <!-- Önizleme Başlığı -->
      <div class="preview-header">
        <span>{{ selectedFiles.length }}/{{ maxFiles }} fotoğraf</span>
        <button class="clear-files-btn"
                (click)="clearAllFiles()">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <!-- Önizleme Izgara -->
      <div class="preview-grid">
        <div *ngFor="let file of selectedFiles"
             class="preview-item">
          <!-- Önizleme Resim -->
          <div class="preview-image-wrapper">
            <img [src]="file.preview"
                 [alt]="file.name"
                 class="preview-image">
            <button class="remove-file-btn"
                    (click)="onFileRemove(file.id)">
              <i class="pi pi-times"></i>
            </button>
          </div>
          <!-- Dosya Bilgileri -->
          <div class="preview-info">
            <span class="file-name">{{ file.name }}</span>
            <span class="file-size">{{ getFileSizeText(file.size) }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Giriş Alanı -->
    <div class="input-wrapper">
      <!-- Dosya Yükleme -->
      <div class="file-upload-section">
        <input type="file"
               #fileInput
               multiple
               accept="image/*"
               [disabled]="selectedFiles.length >= maxFiles"
               (change)="onFileSelect($event)"
               style="display: none;">

        <button class="upload-btn"
                [disabled]="selectedFiles.length >= maxFiles"
                (click)="fileInput.click()"
                title="Fotoğraf ekle"
                (mouseenter)="onButtonHover($event, true)"
                (mouseleave)="onButtonHover($event, false)">
          <i class="pi pi-paperclip"></i>
        </button>

        <span *ngIf="selectedFiles.length > 0"
              class="file-count-badge">
          {{ selectedFiles.length }}
        </span>
      </div>

      <!-- Metin Girişi -->
      <input type="text"
             [(ngModel)]="newMessage"
             placeholder="Mesajınızı yazın..."
             (keydown.enter)="onSendMessage()"
             [disabled]="isLoading"
             class="message-input">

      <!-- Gönder Butonu -->
      <button class="send-btn"
              [disabled]="!newMessage.trim() && selectedFiles.length === 0 || isLoading"
              (click)="onSendMessage()"
              (mouseenter)="onButtonHover($event, true)"
              (mouseleave)="onButtonHover($event, false)">
        <i class="pi pi-send"></i>
      </button>
    </div>
  </div>
</div>


