<div class="chat-messages-container">
  <div class="messages-wrapper">
    <!-- Messages Area -->
    <div *ngIf="currentSessionId" #messagesList class="messages-scroll-area" (scroll)="onScroll($event)">
      <div class="messages-content">
        <!-- Message Cards -->
        <div *ngFor="let message of messages" 
             class="message-wrapper"
             [ngClass]="{'user-message-wrapper': message.sender === 'user', 'ai-message-wrapper': message.sender === 'ai'}">
          
          <div class="message-avatar">
            <p-avatar [icon]="getUserAvatarIcon(message.sender)"
              [style]="{'background-color': getUserAvatarColor(message.sender), 'color': 'white'}"
                     size="normal" shape="circle">
            </p-avatar>
          </div>

          <p-card class="message-card">
            <div class="message-content">
              <!-- Code blocks or plain text -->
              <ng-container *ngIf="hasCodeBlocks(message.content); else plainText">
                <ng-container *ngFor="let part of parseMessageContent(message.content)">
                  <div *ngIf="part.type === 'text'" class="text-content">{{ part.content }}</div>
                  <app-code-block *ngIf="part.type === 'code'" [code]="part.content" [language]="part.language || 'text'"></app-code-block>
                </ng-container>
              </ng-container>
              
              <ng-template #plainText>
                <!-- Images -->
                <div *ngFor="let imageUrl of message.imageUrl; trackBy: trackByImageUrl" class="message-image">
                  <p-image [src]="getImageUrl(imageUrl)"
                          [alt]="'Message image'"
                          [preview]="true"
                          loading="lazy"
                          (onError)="onImageError($event, imageUrl)"
                          (onLoad)="onImageLoad(imageUrl)"
                          class="message-img">
                    </p-image>
                  </div>
                  
                <!-- Text content -->
                <div class="text-content" *ngIf="message.content && !isImageUrl(message.content)">
                    {{ message.content }}
                  </div>
              </ng-template>
            </div>
            
            <div class="message-timestamp">
              <small>{{ message.timestamp | date:'dd/MM/yyyy HH:mm' }}</small>
            </div>
          </p-card>
        </div>

        <!-- AI Loading Indicator -->
        <div class="message-wrapper ai-message-wrapper" *ngIf="isLoading">
          <div class="message-avatar">
            <p-avatar icon="pi pi-android"
                     [style]="{'background-color': '#10b981', 'color': 'white'}"
                     size="normal" shape="circle">
            </p-avatar>
          </div>
          <p-card class="message-card typing-card">
              <div class="typing-indicator">
              <i class="pi pi-android"></i>
              <span>AI yanıtlıyor</span>
                <div class="typing-dots">
                  <span class="dot"></span>
                  <span class="dot"></span>
                  <span class="dot"></span>
                </div>
              </div>
            </p-card>
        </div>
      </div>
    </div>

    <!-- Scroll to Bottom Button -->
    <p-button *ngIf="showScrollToBottomButton" 
      class="scroll-to-bottom-btn"
      icon="pi pi-angle-down"
      [rounded]="true"
      severity="primary"
      pTooltip="Aşağı git"
      (onClick)="scrollToBottomSmooth()">
    </p-button>
  </div>

  <!-- Message Input -->
  <div class="message-input-container">
    <!-- File Preview -->
    <div class="file-preview-area" *ngIf="selectedFiles.length > 0">
      <div class="preview-header">
        <span>{{ selectedFiles.length }}/{{ maxFiles }} fotoğraf</span>
        <p-button icon="pi pi-times" [text]="true" size="small" (click)="clearAllFiles()"></p-button>
      </div>
      
      <div class="preview-grid">
        <div class="preview-item" *ngFor="let file of selectedFiles">
          <div class="preview-image-wrapper">
            <img [src]="file.preview" [alt]="file.name" class="preview-image">
            <p-button icon="pi pi-times" [rounded]="true" size="small" severity="danger" 
                     (click)="onFileRemove(file.id || '')" class="remove-btn">
              </p-button>
          </div>
          <div class="preview-info">
            <span class="file-name">{{ file.name }}</span>
            <span class="file-size">{{ getFileSizeText(file.size) }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="input-wrapper">
      <!-- File Upload -->
      <div class="file-upload-section">
        <input type="file" #fileInput multiple accept="image/*" 
          [disabled]="selectedFiles.length >= maxFiles"
               (change)="onFileSelect($event)" style="display: none;">
        
        <p-button icon="pi pi-paperclip" [text]="true" size="small"
          [disabled]="selectedFiles.length >= maxFiles"
          (click)="fileInput.click()"
                 pTooltip="Fotoğraf ekle">
        </p-button>
        
        <p-badge *ngIf="selectedFiles.length > 0" [value]="selectedFiles.length.toString()" severity="info"></p-badge>
      </div>

      <!-- Text Input -->
      <input type="text" pInputText [(ngModel)]="newMessage"
        placeholder="Mesajınızı yazın..."
        (keydown.enter)="onSendMessage()"
             [disabled]="isLoading"
             class="message-input">

      <!-- Send Button -->
      <p-button icon="pi pi-send"
        [disabled]="!newMessage.trim() && selectedFiles.length === 0 || isLoading"
        (click)="onSendMessage()"
        [rounded]="true"
               severity="info">
      </p-button>
    </div>
  </div>
</div>
